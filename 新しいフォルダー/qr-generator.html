<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KCBF AUTUMN LEAGUE QRコード（Wikipediaスタイル）</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            min-height: 88vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 18px;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #a97b2c;
        }
        .header-logo {
            width: 68px;
            height: 68px;
            object-fit: contain;
        }
        .header-main {
            text-align: left;
            flex: 1;
        }
        .header-main h1 {
            color: #a97b2c;
            font-size: 2.2em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            line-height: 1.2;
        }
        .header-main p {
            color: #666;
            font-size: 1.15em;
            margin: 10px 0 0 0;
        }
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
            margin-top: 90px;
            padding: 0;
            background: none;
            border-radius: 10px;
        }
        .btn {
            background: linear-gradient(45deg, #a97b2c, #c49b61);
            color: white;
            border: none;
            padding: 18px 40px;
            margin: 10px;
            border-radius: 32px;
            font-size: 1.25em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(169, 123, 44, 0.3);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(169, 123, 44, 0.4);
        }
        .btn:active {
            transform: translateY(0);
        }
        .print-btn {
            background: linear-gradient(45deg, #6c757d, #495057);
            box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
            padding: 15px 50px;
            font-size: 1.3em;
            border-radius: 8px;
            min-width: 120px;
        }
        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        .qr-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 380px;
            box-sizing: border-box;
        }
        .qr-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-color: #a97b2c;
        }
        .qr-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #a97b2c;
            margin-bottom: 15px;
            padding: 10px;
            background: linear-gradient(135deg, #fff8e1, #f3e5ab);
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
        }
        .qr-code {
            margin: 0 0 20px 0;
            padding: 10px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 256px;
            height: 256px;
            box-sizing: border-box;
        }
        .qr-code svg {
            width: 100%;
            height: 100%;
            display: block;
        }
        .qr-info {
            font-size: 0.9em;
            color: #666;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-family: monospace;
            width: 100%;
            box-sizing: border-box;
        }
        .download-btn {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }
        .download-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
        }
        .print-page {
            page-break-after: always;
            width: 100vw;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 30px 30px 50px 30px;
            box-sizing: border-box;
        }
        .print-header {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            width: 100%;
            gap: 30px;
        }
        .print-header-logo {
            width: 110px;
            height: 110px;
            object-fit: contain;
            margin-right: 28px;
        }
        .print-header-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 0;
        }
        .print-header-title1 {
            font-size: 3.2em;
            color: #a97b2c;
            font-weight: bold;
            margin-bottom: 8px;
            line-height: 1.07;
            letter-spacing: 0.02em;
        }
        .print-header-title2 {
            font-size: 1.85em;
            color: #222;
            margin-bottom: 0;
            line-height: 1.13;
            font-weight: 600;
        }
        .print-header-hr {
            border: none;
            border-top: 3.5px solid #a97b2c;
            width: 100%;
            margin: 24px 0 36px 0;
        }
        .print-qr-num {
            font-size: 1.55em;
            color: #333;
            margin-bottom: 35px;
            text-align: center;
        }
        .print-qr-svg-box {
            width: 500px;
            height: 500px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            flex: 1 0 auto;
        }
        @media print {
            @page {
                margin: 0;
                size: A4;
            }
            body {
                background: white;
                padding: 0;
                margin: 0;
            }
            .container {
                box-shadow: none;
                padding: 0;
                margin: 0;
            }
            .controls, .qr-grid, .qr-card, .progress-bar, #qrContainer, .header {
                display: none !important;
            }
            .print-section {
                display: block !important;
            }
            .print-page {
                page-break-after: always;
                width: 100vw;
                min-height: 100vh;
                padding: 30px 30px 50px 30px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
                margin: 0;
            }
            .print-header-logo {
                width: 110px;
                height: 110px;
            }
            .print-header-title1 {
                font-size: 3.2em;
            }
            .print-header-title2 {
                font-size: 1.85em;
            }
            .print-header-hr {
                border-top-width: 3.5px;
                margin: 24px 0 36px 0;
            }
            .print-qr-svg-box {
                width: 540px;
                height: 540px;
                margin: 0 auto;
                display: flex;
                align-items: center;
                justify-content: center;
                flex: 1 0 auto;
            }
        }
        .print-section {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img class="header-logo" src="logo.png" alt="KCBF Autumn League ロゴ" />
            <div class="header-main">
                <h1>KCBF AUTUMN LEAGUE</h1>
                <p>スタンプラリー QRコード (1-23)</p>
            </div>
        </div>
        <div class="controls">
            <button class="btn print-btn" onclick="showPrintPages()" id="printBtn">印刷</button>
        </div>
        <div class="progress-bar" id="progressBar" style="display:none;">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div id="qrContainer"></div>
        <div id="svgTemp" style="display:none"></div>
        <div id="printSection" class="print-section"></div>
    </div>

    <script>
        // ここをLIFFのURL＋?stamp=...パラメータ方式に変更
        const BASE_URL = "https://liff.line.me/2007663892-mQOQRy2z";

        const stampQRCodes = {};
        for(let i=1; i<=23; i++) {
            stampQRCodes[i] = `${BASE_URL}?stamp=KCBF_STAMP_${i.toString().padStart(3,"0")}`;
        }
        let svgStore = {};

        // ページ読み込み時に自動でQRコードを生成
        window.onload = function() {
            generateAllQR();
        };

        async function generateAllQR() {
            const container = document.getElementById('qrContainer');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const printBtn = document.getElementById('printBtn');
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';
            container.innerHTML = '<div class="loading">QRコードを生成中...</div>';
            svgStore = {};

            const qrGrid = document.createElement('div');
            qrGrid.className = 'qr-grid';
            const totalStamps = 23;

            for (let i = 1; i <= totalStamps; i++) {
                const progress = (i / totalStamps) * 100;
                progressFill.style.width = progress + '%';
                const qrData = stampQRCodes[i];

                const qrCard = document.createElement('div');
                qrCard.className = 'qr-card';
                const qrTitle = document.createElement('div');
                qrTitle.className = 'qr-title';
                qrTitle.textContent = `スタンプ ${i}`;

                const qrCodeDiv = document.createElement('div');
                qrCodeDiv.className = 'qr-code';

                // 表示用は256px
                const svg = generateWikipediaQR(qrData, 256, 0.13);
                qrCodeDiv.innerHTML = svg;
                // ダウンロード・印刷用SVGは600pxで中央寄せ・余白多め
                svgStore[i] = generateWikipediaQR(qrData, 600, 0.13);

                const qrInfo = document.createElement('div');
                qrInfo.className = 'qr-info';
                qrInfo.textContent = `データ: ${qrData}`;

                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'download-btn';
                downloadBtn.textContent = '💾 PNG保存';
                downloadBtn.onclick = () => downloadPNG(qrData, svgStore[i]);

                qrCard.appendChild(qrTitle);
                qrCard.appendChild(qrCodeDiv);
                qrCard.appendChild(qrInfo);
                qrCard.appendChild(downloadBtn);

                qrGrid.appendChild(qrCard);

                if (i % 5 === 0) await new Promise(resolve => setTimeout(resolve, 50));
            }

            container.innerHTML = '';
            container.appendChild(qrGrid);

            setTimeout(() => {
                progressBar.style.display = 'none';
                printBtn.style.display = 'inline-block';
            }, 500);
        }

        function generateWikipediaQR(data, size=600, marginRate=0.13) {
            var qr = qrcode(0, 'Q');
            qr.addData(data);
            qr.make();
            var moduleCount = qr.getModuleCount();
            var margin = size * marginRate;
            var qrBoxSize = size - 2 * margin;
            var cellSize = qrBoxSize / moduleCount;
            var qrActualSize = cellSize * moduleCount;
            var start = (size - qrActualSize) / 2;

            let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">`;
            svg += `<rect width="100%" height="100%" fill="#fff"/>`;
            for (var r = 0; r < moduleCount; r++) {
                for (var c = 0; c < moduleCount; c++) {
                    if (qr.isDark(r, c)) {
                        svg += `<rect x="${start + c * cellSize}" y="${start + r * cellSize}" width="${cellSize}" height="${cellSize}" fill="#000"/>`;
                    }
                }
            }
            svg += `</svg>`;
            return svg;
        }

        function downloadPNG(qrData, svg) {
            const image = new Image();
            const svgBlob = new Blob([svg], {type: "image/svg+xml;charset=utf-8"});
            const url = URL.createObjectURL(svgBlob);

            image.onload = function() {
                const canvas = document.createElement('canvas');
                canvas.width = image.width;
                canvas.height = image.height;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = "#fff";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
                URL.revokeObjectURL(url);

                canvas.toBlob(function(blob) {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `stampqr_${qrData.match(/STAMP_\d+/)[0]}.png`;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        URL.revokeObjectURL(a.href);
                        a.remove();
                    }, 100);
                }, "image/png");
            };
            image.onerror = function() {
                alert("PNG変換に失敗しました");
                URL.revokeObjectURL(url);
            };
            image.src = url;
        }

        function showPrintPages() {
            const printSection = document.getElementById('printSection');
            printSection.innerHTML = '';
            for(let i=1; i<=23; i++) {
                const page = document.createElement('div');
                page.className = 'print-page';

                const header = document.createElement('div');
                header.className = 'print-header';
                const logo = document.createElement('img');
                logo.src = 'logo.png';
                logo.alt = 'KCBF Autumn League ロゴ';
                logo.className = 'print-header-logo';
                const headerContent = document.createElement('div');
                headerContent.className = 'print-header-content';
                const title1 = document.createElement('div');
                title1.className = 'print-header-title1';
                title1.textContent = 'KCBF AUTUMN LEAGUE';
                const title2 = document.createElement('div');
                title2.className = 'print-header-title2';
                title2.textContent = 'スタンプラリー QRコード (1-23)';
                headerContent.appendChild(title1);
                headerContent.appendChild(title2);
                header.appendChild(logo);
                header.appendChild(headerContent);

                const hr = document.createElement('hr');
                hr.className = 'print-header-hr';

                const qrNum = document.createElement('div');
                qrNum.className = 'print-qr-num';
                qrNum.textContent = `スタンプ ${i}`;

                const qrSvgBox = document.createElement('div');
                qrSvgBox.className = 'print-qr-svg-box';
                qrSvgBox.innerHTML = generateWikipediaQR(stampQRCodes[i], 500, 0.13);

                page.appendChild(header);
                page.appendChild(hr);
                page.appendChild(qrNum);
                page.appendChild(qrSvgBox);

                printSection.appendChild(page);
            }
            printSection.style.display = "block";
            window.print();
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.js"></script>
</body>
</html>
